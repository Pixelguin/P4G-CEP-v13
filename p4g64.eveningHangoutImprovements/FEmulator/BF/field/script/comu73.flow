import("nightHangouts.msg");

void SCR_NIGHT_NPC_EBI_hook()
{
    int var32;
    int var16;
    int var17;
    int var13;
    int var14;
    int var15;
    int slId;
    int var21;
    int var22;
    int var25;
    int var23;
    int var24;
    int var28;
    int var29;
    int var27;
    int var30;
    int var31;
    int var18;
    int var19;
    int var26;
    int selectedChoice;
    
    if ( BIT_CHK( 2388 ) == 1 )
    {
        
        if ( BIT_CHK( 1558 ) == 1 )
        {
            var32 = 2;
        }
        else 
        {
            var32 = 1;
        }

    }
    else if ( ( GET_SL_LEVEL( 21 ) >= 6 ) || ( EVT_FUNCTION_0002( 22 ) == 1 ) )
    {
        var32 = 3;
    }
    else 
    {
        var32 = 0;
    }

    var16 = 239;
    var17 = GET_CNT( var16 );
    var13 = 63;
    var14 = 1;
    var15 = 511;
    slId = EVT_FUNCTION_0022( 21 );
    var21 = 22;
    var22 = 39;
    var25 = 57;
    var23 = 61;
    var24 = 62;
    
    if ( var32 == 1 )
    {
        var28 = 74;
    }
    else if ( var32 == 2 )
    {
        var28 = 75;
    }
    else if ( var32 == 3 )
    {
        var28 = 76;
    }
    else 
    {
        var28 = 73;
    }

    
    if ( var32 == 1 )
    {
        var29 = 78;
    }
    else if ( var32 == 2 )
    {
        var29 = 79;
    }
    else if ( var32 == 3 )
    {
        var29 = 80;
    }
    else 
    {
        var29 = 77;
    }

    
    if ( var32 == 1 )
    {
        var27 = 82;
    }
    else if ( var32 == 2 )
    {
        var27 = 83;
    }
    else if ( var32 == 3 )
    {
        var27 = 84;
    }
    else 
    {
        var27 = 81;
    }

    
    if ( var32 >= 1 )
    {
        var30 = 0x40;
    }
    else 
    {
        var30 = 63;
    }

    
    if ( var17 >= 10 )
    {
        var31 = ( ( var17 / 10 ) * 10 );
    }
    else 
    {
        var31 = 0;
    }

    var18 = ( var17 - var31 );
    var19 = ( var17 / 10 );
    
    if ( var19 >= 10 )
    {
        var19 = ( var19 - 10 );
    }

    
    if ( ( CHECK_TIME_SPAN( 12, 8, 12, 24 ) == 1 ) && ( BIT_CHK( 23 ) == 0 ) )
    {
        
        if ( var32 == 1 )
        {
            var26 = 105;
        }
        else if ( var32 == 2 )
        {
            var26 = 117;
        }
        else if ( var32 == 3 )
        {
            var26 = 129;
        }
        else 
        {
            var26 = 93;
        }

        
        if ( ( var19 >= 2 ) && ( var17 >= 100 ) )
        {
            var25 = 60;
        }
        else 
        {
            var25 = 59;
        }

    }
    else if ( var32 == 1 )
    {
        
        if ( ( var19 >= 2 ) && ( var17 >= 100 ) )
        {
            var26 = 97;
        }
        else if ( CHECK_TIME_SPAN( 4, 11, 4, 30 ) == 1 )
        {
            var26 = 97;
        }
        else if ( CHECK_TIME_SPAN( 5, 1, 5, 31 ) == 1 )
        {
            var26 = 98;
        }
        else if ( CHECK_TIME_SPAN( 6, 1, 6, 30 ) == 1 )
        {
            var26 = 99;
        }
        else if ( CHECK_TIME_SPAN( 7, 1, 7, 31 ) == 1 )
        {
            var26 = 100;
        }
        else if ( CHECK_TIME_SPAN( 8, 1, 8, 31 ) == 1 )
        {
            var26 = 101;
        }
        else if ( CHECK_TIME_SPAN( 9, 1, 9, 30 ) == 1 )
        {
            var26 = 102;
        }
        else if ( CHECK_TIME_SPAN( 10, 1, 10, 31 ) == 1 )
        {
            var26 = 103;
        }
        else if ( CHECK_TIME_SPAN( 11, 1, 11, 30 ) == 1 )
        {
            var26 = 104;
        }
        else if ( CHECK_TIME_SPAN( 12, 1, 12, 31 ) == 1 )
        {
            var26 = 106;
        }
        else if ( CHECK_TIME_SPAN( 1, 1, 1, 31 ) == 1 )
        {
            var26 = 107;
        }
        else if ( CHECK_TIME_SPAN( 2, 1, 2, 29 ) == 1 )
        {
            var26 = 108;
        }
        else if ( CHECK_TIME_SPAN( 3, 1, 3, 21 ) == 1 )
        {
            var26 = 97;
        }
        else 
        {
            var26 = 97;
        }

    }
    else if ( var32 == 2 )
    {
        
        if ( ( var19 >= 2 ) && ( var17 >= 100 ) )
        {
            var26 = 109;
        }
        else if ( CHECK_TIME_SPAN( 4, 11, 4, 30 ) == 1 )
        {
            var26 = 109;
        }
        else if ( CHECK_TIME_SPAN( 5, 1, 5, 31 ) == 1 )
        {
            var26 = 110;
        }
        else if ( CHECK_TIME_SPAN( 6, 1, 6, 30 ) == 1 )
        {
            var26 = 111;
        }
        else if ( CHECK_TIME_SPAN( 7, 1, 7, 31 ) == 1 )
        {
            var26 = 112;
        }
        else if ( CHECK_TIME_SPAN( 8, 1, 8, 31 ) == 1 )
        {
            var26 = 113;
        }
        else if ( CHECK_TIME_SPAN( 9, 1, 9, 30 ) == 1 )
        {
            var26 = 114;
        }
        else if ( CHECK_TIME_SPAN( 10, 1, 10, 31 ) == 1 )
        {
            var26 = 115;
        }
        else if ( CHECK_TIME_SPAN( 11, 1, 11, 30 ) == 1 )
        {
            var26 = 116;
        }
        else if ( CHECK_TIME_SPAN( 12, 1, 12, 31 ) == 1 )
        {
            var26 = 118;
        }
        else if ( CHECK_TIME_SPAN( 1, 1, 1, 31 ) == 1 )
        {
            var26 = 119;
        }
        else if ( CHECK_TIME_SPAN( 2, 1, 2, 29 ) == 1 )
        {
            var26 = 120;
        }
        else if ( CHECK_TIME_SPAN( 3, 1, 3, 21 ) == 1 )
        {
            var26 = 109;
        }
        else 
        {
            var26 = 109;
        }

    }
    else if ( var32 == 3 )
    {
        
        if ( ( var19 >= 2 ) && ( var17 >= 100 ) )
        {
            var26 = 121;
        }
        else if ( CHECK_TIME_SPAN( 4, 11, 4, 30 ) == 1 )
        {
            var26 = 121;
        }
        else if ( CHECK_TIME_SPAN( 5, 1, 5, 31 ) == 1 )
        {
            var26 = 122;
        }
        else if ( CHECK_TIME_SPAN( 6, 1, 6, 30 ) == 1 )
        {
            var26 = 123;
        }
        else if ( CHECK_TIME_SPAN( 7, 1, 7, 31 ) == 1 )
        {
            var26 = 124;
        }
        else if ( CHECK_TIME_SPAN( 8, 1, 8, 31 ) == 1 )
        {
            var26 = 125;
        }
        else if ( CHECK_TIME_SPAN( 9, 1, 9, 30 ) == 1 )
        {
            var26 = 126;
        }
        else if ( CHECK_TIME_SPAN( 10, 1, 10, 31 ) == 1 )
        {
            var26 = 127;
        }
        else if ( CHECK_TIME_SPAN( 11, 1, 11, 30 ) == 1 )
        {
            var26 = 0x80;
        }
        else if ( CHECK_TIME_SPAN( 12, 1, 12, 31 ) == 1 )
        {
            var26 = 130;
        }
        else if ( CHECK_TIME_SPAN( 1, 1, 1, 31 ) == 1 )
        {
            var26 = 131;
        }
        else if ( CHECK_TIME_SPAN( 2, 1, 2, 29 ) == 1 )
        {
            var26 = 132;
        }
        else if ( CHECK_TIME_SPAN( 3, 1, 3, 21 ) == 1 )
        {
            var26 = 121;
        }
        else 
        {
            var26 = 121;
        }

    }
    else if ( ( var19 >= 2 ) && ( var17 >= 100 ) )
    {
        var26 = 85;
    }
    else if ( CHECK_TIME_SPAN( 4, 11, 4, 30 ) == 1 )
    {
        var26 = 85;
    }
    else if ( CHECK_TIME_SPAN( 5, 1, 5, 31 ) == 1 )
    {
        var26 = 86;
    }
    else if ( CHECK_TIME_SPAN( 6, 1, 6, 30 ) == 1 )
    {
        var26 = 87;
    }
    else if ( CHECK_TIME_SPAN( 7, 1, 7, 31 ) == 1 )
    {
        var26 = 88;
    }
    else if ( CHECK_TIME_SPAN( 8, 1, 8, 31 ) == 1 )
    {
        var26 = 89;
    }
    else if ( CHECK_TIME_SPAN( 9, 1, 9, 30 ) == 1 )
    {
        var26 = 90;
    }
    else if ( CHECK_TIME_SPAN( 10, 1, 10, 31 ) == 1 )
    {
        var26 = 91;
    }
    else if ( CHECK_TIME_SPAN( 11, 1, 11, 30 ) == 1 )
    {
        var26 = 92;
    }
    else if ( CHECK_TIME_SPAN( 12, 1, 12, 31 ) == 1 )
    {
        var26 = 94;
    }
    else if ( CHECK_TIME_SPAN( 1, 1, 1, 31 ) == 1 )
    {
        var26 = 95;
    }
    else if ( CHECK_TIME_SPAN( 2, 1, 2, 29 ) == 1 )
    {
        var26 = 96;
    }
    else if ( CHECK_TIME_SPAN( 3, 1, 3, 21 ) == 1 )
    {
        var26 = 85;
    }
    else 
    {
        var26 = 85;
    }

    
    if ( ( var19 >= 2 ) && ( var17 >= 100 ) )
    {
        var25 = 58;
    }

    
    if ( ( CHECK_TIME_SPAN( 4, 11, 7, 31 ) == 1 ) || ( CHECK_TIME_SPAN( 11, 1, 11, 30 ) == 1 ) )
    {
        
        if ( var32 == 1 )
        {
            var28 = 70;
        }
        else if ( var32 == 2 )
        {
            var28 = 71;
        }
        else if ( var32 == 3 )
        {
            var28 = 72;
        }
        else 
        {
            var28 = 69;
        }

    }

    
    if ( CHECK_TIME_SPAN( 7, 26, 8, 31 ) == 1 )
    {
        
        if ( var28 == 69 )
        {
            var28 = 133;
        }
        else if ( var28 == 70 )
        {
            var28 = 134;
        }
        else if ( var28 == 71 )
        {
            var28 = 135;
        }
        else if ( var28 == 72 )
        {
            var28 = 136;
        }

        
        if ( var28 == 73 )
        {
            var28 = 137;
        }
        else if ( var28 == 74 )
        {
            var28 = 138;
        }
        else if ( var28 == 75 )
        {
            var28 = 139;
        }
        else if ( var28 == 76 )
        {
            var28 = 140;
        }

        
        if ( var29 == 77 )
        {
            var29 = 141;
        }
        else if ( var29 == 78 )
        {
            var29 = 142;
        }
        else if ( var29 == 79 )
        {
            var29 = 143;
        }
        else if ( var29 == 80 )
        {
            var29 = 144;
        }

        
        if ( var27 == 81 )
        {
            var27 = 145;
        }
        else if ( var27 == 82 )
        {
            var27 = 146;
        }
        else if ( var27 == 83 )
        {
            var27 = 147;
        }
        else if ( var27 == 84 )
        {
            var27 = 148;
        }

        
        if ( var26 == 85 )
        {
            var26 = 149;
        }
        else if ( var26 == 97 )
        {
            var26 = 150;
        }
        else if ( var26 == 109 )
        {
            var26 = 151;
        }
        else if ( var26 == 121 )
        {
            var26 = 152;
        }

        
        if ( var26 == 88 )
        {
            var26 = 153;
        }
        else if ( var26 == 100 )
        {
            var26 = 154;
        }
        else if ( var26 == 112 )
        {
            var26 = 155;
        }
        else if ( var26 == 124 )
        {
            var26 = 156;
        }

    }

    OPEN_MSG_WIN();
    
    if ( var18 == 0 )
    {
        var17 = GET_CNT( var16 );
        SET_CNT( var16, ( var17 + 1 ) );
        MSG( var26 );
    }
    else 
    {
        MSG( var27 );
    }

    
    if ( BIT_CHK( 3199 ) == 0 )
    {
        BIT_ON(6381);
        BIT_ON( 3199 );
        CLOSE_MSG_WIN();
        HELP_MSG( NightHangoutHelp );
        OPEN_MSG_WIN();
    }

    // Chat help message
    if(!BIT_CHK(6381))
    {
        BIT_ON(6381);
        CLOSE_MSG_WIN();
        HELP_MSG( ChatHelp );
        OPEN_MSG_WIN();
    }

    MSG( var25 );
    
    if ( ( GET_SL_LEVEL( slId ) < 10 ) && ( EVT_FUNCTION_0019( slId ) != 0 ) )
    {
        EVT_FUNCTION_0013( slId );
        MSG( var22 );
    }
    else if ( GET_SL_LEVEL( slId ) == 10 )
    {
        MSG( EBI_NIGHT_TALK_POINT_MAX );
        
        if ( ( var19 >= 2 ) && ( var17 >= 100 ) )
        {
            MSG( EBI_NIGHT_TALK_POINT_MAX_3 );
        }
        else 
        {
            MSG( EBI_NIGHT_TALK_POINT_MAX_2 );
        }

    }
    
    EVT_FUNCTION_0013( slId );
    if(CHECK_IF_SL_LVLUP(slId))
        MSG(NightWaitSuggestion);
    MSG( var23 );
    SEL_CHK_PAD( 14, 2 );
    selectedChoice = SEL( HangoutSel );
    CLOSE_MSG_WIN();
    
    if ( selectedChoice <= 1 )
    {
        bool isChat = selectedChoice == 1;
        OPEN_MSG_WIN();
        MSG( var28 );
        CLOSE_MSG_WIN();
        
        if ( var14 == 0 && !isChat)
        {
            EVT_FUNCTION_0016( slId );
            EVT_FUNCTION_0031( slId, 5, var13 );
        }
        else if ( EVT_FUNCTION_0002( slId ) == 1 && !isChat )
        {
            EVT_FUNCTION_0016( slId );
            EVT_FUNCTION_0031( slId, 5, var13 );
        }
        else if ( EVT_FUNCTION_0002( var21 ) == 1 && !isChat)
        {
            EVT_FUNCTION_0016( var21 );
            EVT_FUNCTION_0031( var21, 5, var13 );
        }

        EVT_FUNCTION_0016( 0 );
        OPEN_MSG_WIN();
        MSG( var30 );
        CLOSE_MSG_WIN();
        FADE( 1, 20 );
        FADE_SYNC();
        if(isChat) {
            BIT_OFF(2187); // Despawn ai
            BIT_ON(6380); // Turn on chatting flag
        }
        CALL_EVENT( 845, var15, 0 );
        BIT_ON( 4074 );
        BIT_OFF( 2571 );
        BIT_OFF(6380); // Turn off chatting flag
        
        if ( BIT_CHK( 3206 ) == 1 )
        {
            var17 = GET_CNT( var16 );
            SET_CNT( var16, ( var17 - 1 ) );
            CALL_FIELD( 8, 2, 1, 0 );
        }
        else if(isChat)
        {
            CALL_FIELD( 8, 2, 1, 0 );

        }
        else 
        {
            commu_yoru();
        }

    }
    else 
    {
        OPEN_MSG_WIN();
        MSG( var29 );
        CLOSE_MSG_WIN();
    }

}

